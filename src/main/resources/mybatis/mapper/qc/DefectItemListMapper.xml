<?xml version="1.0" encoding="UTF-8"?>

<!DOCTYPE mapper
	PUBLIC "-//mybatis.org//DTO Mapper 3.0//EN"
	"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
	
<mapper namespace="com.busience.qc.dao.DefectItemListDao">
	<select id="defectItemListSelectDao" resultType="com.busience.productionLX.dto.WorkOrderDto">
	<![CDATA[
		SELECT	A.WorkOrder_ItemCode, B.PRODUCT_ITEM_NAME WorkOrder_ItemName, B.PRODUCT_INFO_STND_1 WorkOrder_Item_STND_1,
			A.WorkOrder_EquipCode, C.EQUIPMENT_INFO_NAME WorkOrder_EquipName,
			sum(A.WorkOrder_PQty) WorkOrder_PQty, sum(A.WorkOrder_RQty) WorkOrder_RQty, A.WorkOrder_CompleteTime,
            sum(D.Defect_Qty) WorkOrder_DQty
			FROM (
				select * from WorkOrder_tbl
				where WorkOrder_WorkStatus = 245 and WorkOrder_CompleteTime >= #{startDate} and WorkOrder_CompleteTime < #{endDate}
			) A
			inner join PRODUCT_INFO_TBL B on A.WorkOrder_ItemCode = B.PRODUCT_ITEM_CODE
			inner join EQUIPMENT_INFO_TBL C on A.WorkOrder_EquipCode = C.EQUIPMENT_INFO_CODE
			left outer join (
				SELECT Defect_ONo, sum(Defect_Qty) Defect_Qty FROM defect_tbl group by Defect_ONo
			) D on A.WorkOrder_ONo = D.Defect_ONo
            group by WorkOrder_ItemCode
	]]>		
	</select>
	
	<select id="defectItemListSubSelectDao" resultType="com.busience.qc.dto.DefectDto">
	<![CDATA[
		SELECT A.Defect_ItemCode, A.Defect_Code, sum(A.Defect_Qty) Defect_Qty, B.WorkOrder_CompleteTime
			from (
				SELECT Defect_ONo, SUBSTRING_INDEX(SUBSTRING_INDEX(Defect_ONo,'-',2),'-',-1) Defect_ItemCode, Defect_Code, Defect_Qty, Defect_Insert_Time
				FROM defect_tbl
			) A
			inner join WorkOrder_tbl B on A.Defect_ONo = B.WorkOrder_ONo
			where B.WorkOrder_CompleteTime >= #{startDate} and B.WorkOrder_CompleteTime < #{endDate} and Defect_ItemCode = #{itemCode}
			group by A.Defect_Code
	]]>	
	</select>
</mapper>