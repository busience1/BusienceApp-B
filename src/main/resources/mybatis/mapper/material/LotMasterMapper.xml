<?xml version="1.0" encoding="UTF-8"?>

<!DOCTYPE mapper
	PUBLIC "-//mybatis.org//DTO Mapper 3.0//EN"
	"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
	 
<mapper namespace="com.busience.material.dao.LotMasterDao">

	<insert id="lotMasterInsertUpdateDao">
		insert into LotMaster_tbl(
			LM_LotNo, LM_ItemCode,
			LM_Qty, LM_Create_Date, LM_Warehouse
		)values(
			#{LM_LotNo}, #{LM_ItemCode},
			#{LM_Qty}, now(), #{LM_Warehouse}
		)on duplicate key update
		LM_Qty = LM_Qty + #{LM_Qty}
	</insert>
	
	<select id="lotMasterMatSelectDao" resultType="com.busience.material.dto.LotMasterDto">
		SELECT
			A.LM_LotNo, A.LM_ItemCode, A.LM_Qty,
		    A.LM_Create_Date, B.InMat_Client_Code LM_ClientCode,
		    C.Cus_Name LM_ClientName, A.LM_Warehouse
		FROM LotMaster_tbl A
		INNER JOIN InMat_tbl B ON A.LM_LotNo = B.InMat_Lot_No and InMat_No = '1'
		INNER JOIN Customer_tbl C ON B.InMat_Client_Code = C.Cus_Code
		INNER JOIN DTL_TBL D ON B.InMat_Rcv_Clsfc = D.Child_TBL_No and D.New_TBL_Code = '17'
		where A.LM_Qty > 0
		<if test="ItemCode != null">
			and A.LM_ItemCode = #{itemCode}
		</if>
		<if test="warehouse != null">
       		and A.LM_Warehouse = #{warehouse}
       	</if>
	</select>
	
	<select id="lotMasterSelectDao" resultType="com.busience.material.dto.LotMasterDto">
		SELECT
			A.LM_LotNo, A.LM_ItemCode, B.Product_Item_Name LM_ItemName,
		    A.LM_Qty, A.LM_Create_Date, A.LM_Warehouse,
		    C.Child_TBL_Type LM_Warehouse_Name
		FROM LotMaster_tbl A
		inner join Product_Info_tbl B on A.LM_ItemCode = B.Product_Item_Code
		inner join DTL_TBL C on A.LM_Warehouse = C.Child_TBL_No
       	<if test="LotNo != null">
       		where A.LM_LotNo = #{LotNo}
       	</if>
       	<if test="warehouse != null">
       		and A.LM_Warehouse != #{warehouse}
       	</if>
	</select>
	
	<select id="salesOutputLotMasterDao" resultType="com.busience.material.dto.LotMasterDto">
		select 
			LM_LotNo, LM_ItemCode, pit.Product_Item_Name LM_ItemName,
			pit.Product_Info_STND_1 LM_STND_1, 
			dt.Child_TBL_Type LM_Item_CLSFC_1,
			LM_Qty
		from LotMaster_tbl lmt 
		inner join Product_Info_tbl pit on lmt.LM_ItemCode = pit.Product_Item_Code 
		inner join DTL_TBL dt on pit.Product_Item_CLSFC_1 = dt.Child_TBL_No
		where lmt.LM_Qty > 0 and lmt.LM_Warehouse='52' and lmt.LM_LotNo like concat('L','%')
		<if test="ItemCode != null">
		and lmt.LM_ItemCode = #{ItemCode}
		</if>
		<if test="LotNo != null">
		and lmt.LM_LotNo = #{LotNo}
		</if>
	</select>
	
	<select id="salesInputLotMasterSelectDao" resultType="com.busience.material.dto.LotMasterDto">
		SELECT 
			lmt.*, pit.Product_Item_Name LM_ItemName, pit.Product_Info_STND_1 LM_STND_1, dt.Child_TBL_Type LM_Item_CLSFC_1, spt.Sales_Small_Packing_LotNo
		FROM LotMaster_tbl lmt
		INNER JOIN Product_Info_tbl pit ON lmt.LM_ItemCode = pit.Product_Item_Code
		INNER JOIN DTL_TBL dt ON pit.Product_Item_CLSFC_1 = dt.Child_TBL_No
		LEFT OUTER JOIN Sales_Packing_tbl spt ON lmt.LM_LotNo = spt.Sales_Small_Packing_LotNo
		WHERE lmt.LM_Qty != 0 
		AND lmt.LM_LotNo = #{LM_LotNo} 
		AND lmt.LM_LotNo LIKE 'S%'
		AND lmt.LM_Warehouse = '51'
		AND spt.Sales_Small_Packing_LotNo is null
	</select>
	
	<select id="salesItemListDao" resultType="com.busience.material.dto.LotMasterDto">
		SELECT 
			lmt.*, pit.Product_Item_Name LM_ItemName, pit.Product_Info_STND_1 LM_STND_1, dt.Child_TBL_Type LM_Item_CLSFC_1, spt.Sales_Small_Packing_LotNo
		FROM LotMaster_tbl lmt
		INNER JOIN Product_Info_tbl pit ON lmt.LM_ItemCode = pit.Product_Item_Code
		INNER JOIN DTL_TBL dt ON pit.Product_Item_CLSFC_1 = dt.Child_TBL_No
		LEFT OUTER JOIN Sales_Packing_tbl spt ON lmt.LM_LotNo = spt.Sales_Small_Packing_LotNo
		WHERE lmt.LM_Qty != 0 
		<if test="LotNo != ''">
		AND lmt.LM_LotNo = #{LotNo} 
		</if>
		<![CDATA[
		AND lmt.LM_Create_Date >= #{startDate} and lmt.LM_Create_Date < #{endDate}
		]]>
		AND lmt.LM_LotNo LIKE 'S%'
		AND lmt.LM_Warehouse = '51'
		AND spt.Sales_Small_Packing_LotNo is null
	</select>
	
	<insert id="lotMasterInsertDao">
		insert into LotMaster_tbl(
			LM_LotNo, LM_ItemCode,
			LM_Qty, LM_Create_Date, LM_Warehouse
		)values(
			#{OM_LotNo}, #{OM_ItemCode},
			#{OM_Qty}, now(), #{OM_Warehouse}
		)on duplicate key update
		LM_Qty = LM_Qty + #{OM_Qty}
	</insert>
	
	<insert id="salesLotMasterInsertUpdateDao">
		insert into LotMaster_tbl(
			LM_LotNo, LM_ItemCode,
			LM_Qty, LM_Create_Date, LM_Warehouse
		)values(
			#{LM_LotNo}, #{LM_ItemCode},
			#{LM_Qty}, now(), #{LM_Warehouse}
		)on duplicate key update
		LM_Qty = LM_Qty + #{LM_Qty}
	</insert>
	
	<update id="lotMasterUpdateDao">
		update LotMaster_tbl
		set
		LM_Qty = LM_Qty + #{LM_Qty}
		where LM_LotNo = #{LM_LotNo}
	</update>
</mapper>