<?xml version="1.0" encoding="UTF-8"?>

<!DOCTYPE mapper
	PUBLIC "-//mybatis.org//DTO Mapper 3.0//EN"
	"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
	 
<mapper namespace="com.busience.material.dao.MatOutputDao">
	<select id="LotMasterSelectDao" resultType="com.busience.material.dto.LotMasterDto">
		SELECT
			A.LM_LotNo, A.LM_ItemCode, A.LM_Qty,
		    A.LM_Create_Date, B.InMat_Client_Code LM_ClientCode,
		    C.Cus_Name LM_ClientName
		FROM LotMaster_tbl A
		INNER JOIN InMat_tbl B ON A.LM_LotNo = B.InMat_Lot_No 
		INNER JOIN Customer_tbl C ON B.InMat_Client_Code = C.Cus_Code
		INNER JOIN DTL_TBL D ON B.InMat_Rcv_Clsfc = D.Child_TBL_No and D.New_TBL_Code = '17'
		where A.LM_Qty != 0
		and A.LM_ItemCode = #{ItemCode};
	</select>

	<insert id="outMatInsertDao">
		insert into OutMat_tbl(
			OM_No,
			OM_RequestNo, OM_LotNo,
			OM_ItemCode, OM_Qty, OM_DeptCode,
			OM_Send_Clsfc, OM_OutDate, OM_Modifier
		) values (
			(select ifnull(max(AA.OM_No)+1,1) from OutMat_tbl AS AA where AA.OM_RequestNo = #{OM_RequestNo}),
			#{OM_RequestNo}, #{OM_LotNo},
			#{OM_ItemCode}, #{OM_Qty}, #{OM_DeptCode},
			#{OM_Send_Clsfc}, #{OM_OutDate}, #{OM_Modifier}
		)
	</insert>
	
	<insert id="stockUpdateDao">
		insert into Stock_tbl (
			S_itemCode, S_Qty, S_WareHouse
		)values(
			#{OM_ItemCode}, S_Qty, #{OM_WareHouse}
		)on duplicate key update
		S_Qty = S_Qty+#{OM_Qty}
	</insert>
</mapper>