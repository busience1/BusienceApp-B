<?xml version="1.0" encoding="UTF-8"?>

<!DOCTYPE mapper
	PUBLIC "-//mybatis.org//DTO Mapper 3.0//EN"
	"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
	 
<mapper namespace="com.busience.material.dao.MatOrderDao">
	<select id="matOrderMasterSelectDao" resultType="com.busience.material.dto.OrderMasterDto">
		SELECT 
		 A.Order_mCus_No, A.Order_mCode, B.Cus_Name Order_mName,
		 A.Order_mDate, A.Order_mTotal, A.Order_mDlvry_Date,
		 A.Order_mRemarks, A.Order_mModifier, A.Order_mModify_Date,
		 A.Order_mCheck
		 FROM OrderMaster_tbl A
		 inner join Customer_tbl B on A.Order_mCode = B.Cus_Code
	<![CDATA[
		 where A.Order_mDate >= #{startDate} and Order_mDate < #{endDate}
	]]>
		 and not Order_mCheck = 'Y'
		 and Order_mCode like concat('%',#{ItemCode},'%')
		 order by Order_mDate
	</select>
	
	<select id="matOrderListSelectDao" resultType="com.busience.material.dto.OrderListDto">
		SELECT 
			A.Order_lNo, A.Order_lCus_No,
			B.PRODUCT_ITEM_NAME Order_lName, A.Order_lCode,
			B.PRODUCT_INFO_STND_1 Order_STND_1,
			A.Order_lQty, A.Order_lSum, A.Order_lUnit_Price,
			A.Order_lPrice, A.Order_lNot_Stocked,
			A.Order_Rcv_Clsfc, C.Child_TBL_Type Order_Rcv_Clsfc_Name,
			A.Order_lInfo_Remark
		FROM OrderList_tbl A
		inner join Product_Info_tbl B on A.Order_lCode = B.PRODUCT_ITEM_CODE
		inner join DTL_TBL C on A.Order_Rcv_Clsfc = C.Child_TBL_No
		where Order_lCus_No = #{OrderNo}
		Order by Order_lNo
	</select>
	
	<select id="stockMatSelectDao" resultType="com.busience.material.dto.StockMatDto">
		SELECT 
			A.SM_Code, B.PRODUCT_ITEM_NAME SM_Name,
			B.PRODUCT_INFO_STND_1 SM_STND_1,
			A.SM_Last_Qty+A.SM_In_Qty-A.SM_Out_Qty SM_Qty
		FROM StockMat_tbl A
		inner join Product_Info_tbl B ON A.SM_Code = B.PRODUCT_ITEM_CODE
		where A.SM_Code = #{ItemCode}
	</select>
	
	<select id="matOrderNoCreateDao" resultType="String">
		select
			concat(
				#{Order_mCode},'-',
				date_format(#{Order_mDate},'%y%m%d'),'-',
				lpad(
					1+(
						select IFNULL(
							(
								select max(SUBSTRING_INDEX(Order_mCus_No,'-',-1))
								FROM OrderMaster_tbl
								where SUBSTRING_INDEX(Order_mCus_No, '-', 2) 
								= concat(#{Order_mCode},'-',date_format(#{Order_mDate},'%y%m%d'))
							)
						,0)
					),
			 	2,'0')
			 )
	</select>
	<insert id="matOrderMasterInsertUpdateDao">
		insert into OrderMaster_tbl(
			Order_mCus_No, Order_mCode, Order_mDate,
		    Order_mTotal, Order_mDlvry_Date, Order_mRemarks,
		    Order_mModifier, Order_mModify_Date
		) values (
		    #{Order_mCus_No}, #{Order_mCode}, #{Order_mDate},
		    #{Order_mTotal}, #{Order_mDlvry_Date}, #{Order_mRemarks},
		    #{Order_mModifier}, now()
		) on duplicate key update
		    Order_mTotal = #{Order_mTotal},
		    Order_mDlvry_Date = #{Order_mDlvry_Date},
		    Order_mRemarks = #{Order_mRemarks},
		    Order_mModifier = #{Order_mModifier},
		    Order_mModify_Date = now()
	</insert>
	
	<insert id="matOrderListInsertUpdateDao">
		insert into OrderList_tbl(
			Order_lNo,
			Order_lCus_No, Order_lCode,
		    Order_lQty, Order_lSum, Order_lUnit_Price,
		    Order_lPrice, Order_lNot_Stocked,
		    Order_Rcv_Clsfc, Order_lInfo_Remark
		)values(
			(select ifnull(max(AA.Order_lNo)+1,1) from OrderList_tbl AS AA where AA.Order_lCus_No = #{Order_lCus_No}),
			#{Order_lCus_No}, #{Order_lCode},
		    #{Order_lQty}, #{Order_lSum}, #{Order_lUnit_Price},
		    #{Order_lPrice}, #{Order_lQty},
		    #{Order_Rcv_Clsfc}, #{Order_lInfo_Remark}
		)on duplicate key update
		Order_lQty = #{Order_lQty},
		Order_lUnit_Price = #{Order_lUnit_Price},
		Order_lPrice = #{Order_lPrice},
		Order_lNot_Stocked = #{Order_lQty},
		Order_Rcv_Clsfc = #{Order_Rcv_Clsfc},
		Order_lInfo_Remark = #{Order_lInfo_Remark}
	</insert>
	
	<delete id="matOrderMasterDeleteDao">
		delete from OrderMaster_tbl
		where Order_mCus_No = #{Order_mCus_No}
	</delete>
	
	<delete id="matOrderListDeleteDao">
		delete from OrderList_tbl
		where Order_lCus_No = #{Order_lCus_No}
		and Order_lCode = #{Order_lCode}
	</delete>
</mapper>