<?xml version="1.0" encoding="UTF-8"?>

<!DOCTYPE mapper
	PUBLIC "-//mybatis.org//DTO Mapper 3.0//EN"
	"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
	
<mapper namespace="com.busience.salesLX.dao.SalesPackingDao">
	<select id="salesPackingNoCreateDao" resultType="com.busience.salesLX.dto.SalesPackingDto">
		SELECT COUNT(*)+1 Sales_Packing_No FROM Sales_Packing_tbl
		WHERE Sales_Large_Packing_LotNo = #{Sales_Large_Packing_LotNo} 
	</select>
	
	<select id="salesPackingListSelectDao" resultType="com.busience.salesLX.dto.SalesPackingDto">
		SELECT spt.Sales_Packing_No, spt.Sales_Small_Packing_LotNo, spt.Sales_Packing_Qty, lmt.LM_ItemCode as Sales_Packing_Code, pit.Product_Item_Name as Sales_Packing_Name, lmt.LM_Create_Date as Sales_Small_Create_Date
		FROM Sales_Packing_tbl spt
		INNER JOIN LotMaster_tbl lmt ON spt.Sales_Small_Packing_LotNo = lmt.LM_LotNo
		INNER JOIN Product_Info_tbl pit ON lmt.LM_ItemCode = pit.Product_Item_Code
		WHERE spt.Sales_Large_Packing_LotNo = #{LotNo}
		AND lmt.LM_WareHouse='52'
	</select>
	
	<select id="salesInMatReturnSelectDao" resultType="com.busience.salesLX.dto.SalesPackingDto">
		SELECT spt.Sales_Packing_No, spt.Sales_Large_Packing_LotNo, spt.Sales_Small_Packing_LotNo, spt.Sales_Packing_Qty, lmt.LM_ItemCode as Sales_Packing_Code, pit.Product_Item_Name as Sales_Packing_Name, lmt.LM_Create_Date as Sales_Small_Create_Date, 
			pit.Product_Item_Name AS Sales_Packing_Name, pit.Product_Info_STND_1 AS Sales_Packing_STND_1, 
			dt.Child_TBL_Type AS Sales_Packing_Item_Clsfc_1, 
			spt.Sales_Packing_Status, dt2.Child_TBL_Type AS Sales_Packing_Status_Name 
		FROM Sales_Packing_tbl spt
		INNER JOIN LotMaster_tbl lmt ON spt.Sales_Small_Packing_LotNo = lmt.LM_LotNo
		INNER JOIN Product_Info_tbl pit ON lmt.LM_ItemCode = pit.Product_Item_Code
		INNER JOIN DTL_TBL dt ON pit.Product_Item_CLSFC_1 = dt.Child_TBL_No
		INNER JOIN DTL_TBL dt2 ON spt.Sales_Packing_Status = dt2.Child_TBL_No
		WHERE lmt.LM_Qty = 0
		AND lmt.LM_WareHouse = (SELECT Child_TBL_No FROM DTL_TBL WHERE New_TBL_Code = 10 AND Child_TBL_Type='생산창고')
		AND spt.Sales_Packing_Status != (SELECT Child_TBL_No FROM DTL_TBL WHERE New_TBL_Code = 17 AND Child_TBL_Type='입고반품');  
	</select>
	
	<insert id="salesPackingInsertDao">
		INSERT INTO Sales_Packing_tbl (
			Sales_Packing_No, Sales_Large_Packing_LotNo,
			Sales_Small_Packing_LotNo, Sales_Packing_Qty, Sales_Large_Packing_Time, Sales_Packing_Status
		) VALUES (
			#{Sales_Packing_No}, #{Sales_Large_Packing_LotNo},
			#{Sales_Small_Packing_LotNo}, #{Sales_Packing_Qty}, now(), #{Sales_Packing_Status}
		)
	</insert>
	<update id="salesPackingUpdateDao">
	    UPDATE Sales_Packing_tbl 
	    SET Sales_Packing_Status = '207'
	    WHERE Sales_Small_Packing_LotNo = #{Sales_Small_Packing_LotNo}
	    AND Sales_Packing_Qty = #{Sales_Packing_Qty}
	    AND Sales_Packing_Status = #{Sales_Packing_Status}
	</update>



</mapper>
